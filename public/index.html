<!DOCTYPE html>
<html>
    <head>
        <title>Agenda de AudiÃªncias</title>
        <meta charset="utf-8" />
    </head>
    <body>
        <header id="cabecaho">
            <button id="authorize_button" onclick="handleAuthClick()">Login</button>
            <button id="signout_button" onclick="window.location.reload()">Reload</button>
        </header>
        <div id="root"></div>
        <div id="conteudo"></div>

        <script type="text/javascript">
            const CLIENT_ID = "57090579544-pq7ur7r2r42uqpd6uq5r95g3s55a9jme.apps.googleusercontent.com";
            const API_KEY = "AIzaSyBQLBw71zHs2WEwyepFCOmr7zhdrw9qTBU";
            const DISCOVERY_DOC = "https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest";
            const SCOPES = "https://www.googleapis.com/auth/calendar.readonly";
            const salas_ID = ["38bcd6af79aafc2409e9cb1c517f8011a99008b63ea688e5ea2bdadbdd29317c@group.calendar.google.com", "658e05f590c7fc63f7042bb7ce22fbc37f44d092a73755550f421a3999cecfa8@group.calendar.google.com", "9634a8ad2b9ee6f92e89ee910f88067f2e49036f9333cf45f86beb8ce066b8e0@group.calendar.google.com"];

            let tokenClient;
            let gapiInited = false;
            let gisInited = false;

            const conteudo = document.getElementById("conteudo");
            let eventosDoDia = [];

            document.getElementById("signout_button").style.visibility = "hidden";
            document.getElementById("root").style.visibility = "hidden";

            function gapiLoaded() {
                gapi.load("client", initializeGapiClient);
            }

            async function initializeGapiClient() {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: [DISCOVERY_DOC],
                });
                gapiInited = true;
            }

            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: "",
                });
                gisInited = true;
            }

            function handleAuthClick() {
                tokenClient.callback = async (resp) => {
                    document.getElementById("signout_button").style.visibility = "visible";
                    document.getElementById("authorize_button").style.display = "none";
                    document.getElementById("root").style.visibility = "visible";

                    await listUpcomingEvents();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({ prompt: "consent" });
                } else {
                    tokenClient.requestAccessToken({ prompt: "" });
                }

                eventosDoDia = [];
            }

            async function listUpcomingEvents() {
                let response;

                salas_ID.forEach(async (sala_id) => {
                    try {
                        const request = {
                            calendarId: sala_id,
                            timeMin: new Date().toISOString(),
                            showDeleted: false,
                            singleEvents: true,
                            maxResults: 10,
                            orderBy: "startTime",
                        };
                        response = await gapi.client.calendar.events.list(request);
                    } catch (err) {
                        console.log(err.message);
                        return;
                    }

                    const events = response.result.items;

                    capturaConteudo(events);
                });
            }

            async function capturaConteudo(array) {
                array.forEach((element) => {
                    eventosDoDia.push(element);
                    conteudo.value = eventosDoDia;
                });
            }
        </script>

        <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
        <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    </body>
</html>
